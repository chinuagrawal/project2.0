<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - Kanha Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8fafc;
      }
      /* Toast Styles */
      #toast-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
      }
      .toast {
        background: #1e293b;
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideUpFade 0.3s ease-out forwards;
      }
      @keyframes slideUpFade {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="bg-slate-50">
    <nav class="bg-white shadow-sm p-4 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <button
          onclick="window.location.href = 'booking.html'"
          class="text-slate-500 hover:text-slate-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
        </button>
        <h1 class="text-xl font-bold text-slate-800">My Profile</h1>
      </div>
    </nav>

    <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow-lg">
      <div class="flex flex-col items-center mb-6">
        <div
          class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center text-3xl text-indigo-600 font-bold mb-3 shadow-inner"
        >
          <span id="initials">--</span>
        </div>
        <h2 class="text-xl font-semibold text-slate-800" id="displayName">
          Loading...
        </h2>
        <p class="text-sm text-slate-500">Member</p>
      </div>

      <!-- Wallet Section -->
      <div
        class="mb-6 p-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl text-white shadow-md"
      >
        <div class="flex justify-between items-center mb-1">
          <span class="text-indigo-100 text-sm font-medium"
            >Wallet Balance</span
          >
          <i class="fas fa-wallet text-indigo-200"></i>
        </div>
        <div class="text-3xl font-bold" id="walletBalance">₹ 0</div>
      </div>

      <!-- Referral Section -->
      <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200">
        <h3
          class="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 text-indigo-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
            />
          </svg>
          Refer & Earn ₹50
        </h3>
        <p class="text-xs text-slate-500 mb-4">
          Share this link with friends. When they book, you both get ₹50!
        </p>
        <div class="flex gap-2">
          <input
            type="text"
            id="referralLink"
            readonly
            class="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono text-slate-600 outline-none"
          />
          <button
            onclick="copyReferral()"
            class="bg-white border border-indigo-200 text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-colors"
          >
            Copy
          </button>
        </div>
      </div>

      <form id="profileForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1"
            >First Name</label
          >
          <input
            type="text"
            id="firstName"
            class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1"
            >Last Name</label
          >
          <input
            type="text"
            id="lastName"
            class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none"
            required
          />
        </div>

        <div class="pt-2">
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 transition duration-200 font-medium shadow-md flex justify-center items-center"
          >
            <span>Update Profile</span>
          </button>
        </div>
      </form>
    </div>

    <div id="toast-container"></div>

    <script>
      const BASE_URL = "https://kanhabackend.onrender.com/api";

      const userStr = localStorage.getItem("user");
      if (!userStr) {
        window.location.href = "login.html";
      }
      const user = JSON.parse(userStr);

      // Populate Form
      document.getElementById("firstName").value = user.firstName || "";
      document.getElementById("lastName").value = user.lastName || "";
      document.getElementById("displayName").innerText =
        `${user.firstName} ${user.lastName}`;
      document.getElementById("initials").innerText = (
        (user.firstName?.[0] || "") + (user.lastName?.[0] || "")
      ).toUpperCase();

      // Referral Link
      const refCode = user.referralCode || user._id.slice(-6).toUpperCase();
      const refLink = `${window.location.origin}/login.html?ref=${refCode}`;
      document.getElementById("referralLink").value = refLink;

      function showToast(message) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> ${message}`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transition = "opacity 0.3s ease";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      window.copyReferral = () => {
        const input = document.getElementById("referralLink");
        input.select();
        document.execCommand("copy");
        showToast("Referral link copied!");
      };

      // Wallet Balance
      async function fetchWallet() {
        try {
          const res = await fetch(`${BASE_URL}/users/me/${user.email}`);
          if (res.ok) {
            const data = await res.json();
            document.getElementById("walletBalance").innerText =
              `₹ ${data.walletBalance || 0}`;
          }
        } catch (err) {
          console.error(err);
        }
      }
      fetchWallet();

      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector("button");
          const originalText = btn.innerHTML;
          btn.innerHTML = "Updating...";
          btn.disabled = true;

          const firstName = document.getElementById("firstName").value;
          const lastName = document.getElementById("lastName").value;

          try {
            const res = await fetch(`${BASE_URL}/users/profile`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: user.email, firstName, lastName }),
            });

            const data = await res.json();
            if (res.ok) {
              localStorage.setItem("user", JSON.stringify(data.user));
              // Update display immediately
              document.getElementById("displayName").innerText =
                `${data.user.firstName} ${data.user.lastName}`;
              document.getElementById("initials").innerText = (
                data.user.firstName[0] + data.user.lastName[0]
              ).toUpperCase();

              showToast("Profile Updated Successfully!");
            } else {
              showToast(data.message || "Update failed");
            }
          } catch (err) {
            console.error(err);
            alert("Error connecting to server");
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        });
    </script>
  </body>
</html>
