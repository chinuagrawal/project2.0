<!doctype html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-MS3QJRDZ7C"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-MS3QJRDZ7C");
    </script>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4a148c" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | Kanha Library</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Poppins", "sans-serif"],
            },
            colors: {
              primary: "#4a148c",
              secondary: "#7c43bd",
              glass: "rgba(255, 255, 255, 0.1)",
            },
            animation: {
              "fade-in-up": "fadeInUp 0.5s ease-out",
              "pulse-slow": "pulse 3s infinite",
            },
            keyframes: {
              fadeInUp: {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      /* Fix for autofill overlap - forces label up when browser autofills */
      input:-webkit-autofill + label,
      input:not(:placeholder-shown) + label {
        top: -1.5rem !important;
        font-size: 0.75rem !important;
        color: #7c43bd !important;
      }

      /* Ensure autofilled input text is visible and consistent */
      input:-webkit-autofill {
        -webkit-box-shadow: 0 0 0 30px #2a2a2a inset !important;
        -webkit-text-fill-color: white !important;
        caret-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
      }

      /* Toast Notification */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 50;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        min-width: 300px;
        padding: 16px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease-out forwards;
        opacity: 0;
        transform: translateX(100%);
      }
      .toast.success {
        background: rgba(16, 185, 129, 0.9);
        border: 1px solid #10b981;
      }
      .toast.error {
        background: rgba(239, 68, 68, 0.9);
        border: 1px solid #ef4444;
      }
      .toast.info {
        background: rgba(59, 130, 246, 0.9);
        border: 1px solid #3b82f6;
      }
      @keyframes slideIn {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      /* Hide reCAPTCHA badge */
      .grecaptcha-badge {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
      }
    </style>

    <link rel="stylesheet" href="./login.css?v=1.2" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </head>

  <body
    class="bg-gray-900 font-sans min-h-[100dvh] w-full overflow-x-hidden relative flex flex-col justify-center"
  >
    <!-- Background Image with Overlay -->
    <div
      class="fixed inset-0 z-0 w-full h-full bg-cover bg-center bg-no-repeat"
      style="background-image: url(&quot;login-bg.png&quot;)"
    >
      <div class="absolute inset-0 bg-black/60 backdrop-blur-[2px]"></div>
    </div>

    <!-- Main Container -->
    <div id="toast-container"></div>
    <div class="relative z-10 flex items-center justify-center h-full px-4">
      <!-- Glassmorphism Card -->
      <div
        class="w-full max-w-md bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl shadow-2xl p-6 md:p-8 animate-fade-in-up transform transition-all hover:scale-[1.01] duration-300"
      >
        <div class="text-center mb-8" id="header-text">
          <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">
            Welcome Back
          </h1>
          <p class="text-gray-300 text-sm">
            Sign in to access your library account
          </p>
        </div>

        <form id="login-form" class="space-y-6">
          <!-- Step 1: Mobile -->
          <div id="step-mobile" class="space-y-6">
            <div class="relative group mt-4">
              <i
                class="ri-smartphone-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors z-10"
              ></i>
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="tel"
                id="mobile"
                required
                class="block w-full pl-10 pr-3 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-transparent focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all peer"
                placeholder=" "
              />
              <label
                for="mobile"
                class="absolute left-10 top-3 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3 peer-focus:-top-6 peer-focus:text-xs peer-focus:text-secondary peer-not-placeholder-shown:-top-6 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:text-secondary cursor-text pointer-events-none"
              >
                Mobile Number
              </label>
            </div>
            <button
              type="button"
              id="send-otp-btn"
              class="w-full py-3.5 px-4 bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary ring-offset-black"
            >
              Send OTP
            </button>
          </div>

          <!-- Step 2: OTP (Hidden) -->
          <div id="step-otp" class="hidden space-y-6 animate-fade-in-up">
            <div id="otp-inputs" class="flex justify-between gap-2 mt-4">
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="one-time-code"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="off"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="off"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="off"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="off"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="off"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
            </div>
            <button
              type="submit"
              id="verify-otp-btn"
              class="w-full py-3.5 px-4 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300"
            >
              Verify & Login
            </button>

            <div class="text-center">
              <button
                id="resend-otp-btn"
                type="button"
                class="text-sm text-gray-400 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Resend OTP in <span id="resend-timer">60</span>s
              </button>
            </div>
          </div>

          <!-- Step 3: Register (Hidden) -->
          <div id="step-register" class="hidden space-y-6 animate-fade-in-up">
            <div class="relative group mt-4">
              <i
                class="ri-user-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors z-10"
              ></i>
              <input
                type="text"
                id="fullname"
                class="block w-full pl-10 pr-3 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-transparent focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all peer"
                placeholder=" "
              />
              <label
                for="fullname"
                class="absolute left-10 top-3 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3 peer-focus:-top-6 peer-focus:text-xs peer-focus:text-secondary peer-not-placeholder-shown:-top-6 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:text-secondary cursor-text pointer-events-none"
              >
                Full Name
              </label>
            </div>

            <div class="relative group">
              <i
                class="ri-women-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors"
              ></i>
              <select
                id="gender"
                class="block w-full pl-10 pr-3 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all appearance-none cursor-pointer"
              >
                <option
                  value=""
                  disabled
                  selected
                  class="bg-gray-800 text-gray-400"
                >
                  Select Gender
                </option>
                <option value="Male" class="bg-gray-800 text-white">
                  Male
                </option>
                <option value="Female" class="bg-gray-800 text-white">
                  Female
                </option>
                <option value="Other" class="bg-gray-800 text-white">
                  Other
                </option>
              </select>
              <div
                class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"
              >
                <i class="ri-arrow-down-s-line text-gray-400"></i>
              </div>
            </div>

            <button
              type="button"
              id="register-btn"
              class="w-full py-3.5 px-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300"
            >
              Complete Registration
            </button>
          </div>

          <!-- Footer Text -->
          <div class="text-center mt-6">
            <p class="text-gray-400 text-sm">
              Need help?
              <a
                href="#"
                class="text-white hover:text-secondary hover:underline transition-colors"
                >Contact Support</a
              >
            </p>
          </div>
        </form>
      </div>
    </div>

    <!-- Hidden Signup Link (kept for backward compatibility logic if any, but visually removed/minimized) -->
    <div style="display: none">
      <a href="./signup.html">Register</a>
    </div>

    <script>
      // TODO: REPLACE WITH YOUR FIREBASE CONFIGURATION
      const firebaseConfig = {
        apiKey: "AIzaSyDhzexdsI1HpCDgkxpxlwO-A6rNAM7ikIQ",
        authDomain: "paprplus-912cd.firebaseapp.com",
        projectId: "paprplus-912cd",
        storageBucket: "paprplus-912cd.firebasestorage.app",
        messagingSenderId: "951367264254",
        appId: "1:951367264254:web:f89d8f8ef715aa9ac502af",
        measurementId: "G-XZWSFKDHFY",
      };

      // Toast Notification Function
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        let icon = "ri-information-line";
        if (type === "success") icon = "ri-checkbox-circle-line";
        if (type === "error") icon = "ri-error-warning-line";

        toast.innerHTML = `
          <i class="${icon} text-lg"></i>
          <span>${message}</span>
        `;

        container.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
          toast.style.animation = "fadeOut 0.3s ease-out forwards";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function setLoading(btn, isLoading, text = "Loading...") {
        if (isLoading) {
          btn.dataset.originalText = btn.innerHTML;
          btn.innerHTML = `<i class="ri-loader-4-line animate-spin text-xl"></i>`;
          btn.disabled = true;
          btn.classList.add("opacity-75", "cursor-not-allowed");
        } else {
          btn.innerHTML = btn.dataset.originalText || text;
          btn.disabled = false;
          btn.classList.remove("opacity-75", "cursor-not-allowed");
        }
      }

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      // Set language to default device language
      firebase.auth().useDeviceLanguage();

      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
        "send-otp-btn",
        {
          size: "invisible",
          callback: (response) => {
            // reCAPTCHA solved
          },
        },
      );
      // Pre-render reCAPTCHA to improve performance
      window.recaptchaVerifier.render();

      const sendOtpBtn = document.getElementById("send-otp-btn");
      const verifyOtpBtn = document.getElementById("verify-otp-btn");
      const registerBtn = document.getElementById("register-btn");
      const stepMobile = document.getElementById("step-mobile");
      const stepOtp = document.getElementById("step-otp");
      const stepRegister = document.getElementById("step-register");
      const headerText = document.getElementById("header-text");
      const otpInputs = document.querySelectorAll("#otp-inputs input");
      const resendOtpBtn = document.getElementById("resend-otp-btn");
      const resendTimerSpan = document.getElementById("resend-timer");
      let resendInterval;

      let isRegistration = false;
      let verifiedUser = null;

      // Helper to fill OTP inputs
      function fillOTPInputs(code) {
        const cleanCode = code ? code.toString().replace(/\D/g, "") : "";
        if (cleanCode.length > 0) {
          const codeArr = cleanCode.split("").slice(0, 6);
          otpInputs.forEach((input, i) => {
            if (codeArr[i]) input.value = codeArr[i];
          });

          // Focus logic
          const lastIndex = Math.min(codeArr.length, otpInputs.length - 1);
          if (lastIndex < otpInputs.length) {
            otpInputs[lastIndex].focus();
          } else {
            otpInputs[otpInputs.length - 1].focus();
          }

          // Auto submit if full
          if (cleanCode.length >= 6) {
            verifyOtpBtn.focus(); // Visual feedback
            setTimeout(() => verifyOtpBtn.click(), 100);
          }
        }
      }

      // Handle OTP Inputs Logic (Auto-focus, Backspace, Paste)
      otpInputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
          let value = e.target.value;
          value = value.replace(/\D/g, "");
          e.target.value = value;

          // Handle Paste/Autofill of full code
          if (value.length > 1) {
            fillOTPInputs(value);
            return;
          }

          if (value.length === 1) {
            if (index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }
          }

          // Auto-submit if all fields are filled
          const otp = getOtpValue();
          if (otp.length === 6) {
            verifyOtpBtn.click();
          }
        });

        input.addEventListener("paste", (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData(
            "text",
          );
          fillOTPInputs(paste);
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !e.target.value) {
            if (index > 0) {
              otpInputs[index - 1].focus();
            }
          }
        });

        // Allow only numbers
        input.addEventListener("keypress", function (e) {
          if (e.which < 48 || e.which > 57) {
            e.preventDefault();
          }
        });
      });

      function getOtpValue() {
        let otp = "";
        otpInputs.forEach((input) => {
          otp += input.value;
        });
        return otp;
      }

      function startResendTimer() {
        let timeLeft = 60;
        resendOtpBtn.disabled = true;
        resendTimerSpan.textContent = timeLeft;
        resendOtpBtn.innerHTML = `Resend OTP in <span id="resend-timer">${timeLeft}</span>s`;

        clearInterval(resendInterval);
        resendInterval = setInterval(() => {
          timeLeft--;
          if (document.getElementById("resend-timer")) {
            document.getElementById("resend-timer").textContent = timeLeft;
          }

          if (timeLeft <= 0) {
            clearInterval(resendInterval);
            resendOtpBtn.disabled = false;
            resendOtpBtn.innerHTML = "Resend OTP";
          }
        }, 1000);
      }

      function listenForWebOTP() {
        if ("OTPCredential" in window) {
          const ac = new AbortController();

          navigator.credentials
            .get({
              otp: { transport: ["sms"] },
              signal: ac.signal,
            })
            .then((otp) => {
              const code = otp.code;
              // Remove any non-numeric chars just in case
              const cleanCode = code ? code.replace(/\D/g, "") : "";

              if (cleanCode && cleanCode.length >= 4) {
                fillOTPInputs(cleanCode);
              } else {
                showToast("Received incomplete code: " + code, "error");
              }
            })
            .catch((err) => {
              console.log("WebOTP Error:", err);
            });
        }
      }

      resendOtpBtn.addEventListener("click", function () {
        sendOtpBtn.click();
      });

      sendOtpBtn.addEventListener("click", function () {
        const phoneNumber = document.getElementById("mobile").value.trim();

        if (!phoneNumber) {
          showToast("Please enter a mobile number", "error");
          return;
        }

        // Add +91 if not present (assuming India)
        const formattedPhoneNumber = phoneNumber.startsWith("+")
          ? phoneNumber
          : "+91" + phoneNumber;

        setLoading(sendOtpBtn, true);

        const appVerifier = window.recaptchaVerifier;

        firebase
          .auth()
          .signInWithPhoneNumber(formattedPhoneNumber, appVerifier)
          .then((confirmationResult) => {
            window.confirmationResult = confirmationResult;

            // Switch to OTP Step
            stepMobile.classList.add("hidden");
            stepOtp.classList.remove("hidden");

            // Update Header
            headerText.innerHTML = `
                <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">Enter Verification Code</h1>
                <p class="text-gray-300 text-sm">Sent to ${formattedPhoneNumber}</p>
            `;

            // Focus first OTP input
            setTimeout(() => otpInputs[0].focus(), 100);

            // Listen for WebOTP (Auto-fill from SMS)
            listenForWebOTP();

            // Start Resend Timer
            startResendTimer();
            showToast("OTP sent successfully!", "success");
            setLoading(sendOtpBtn, false);
          })
          .catch((error) => {
            setLoading(sendOtpBtn, false);
            console.error("Error during signInWithPhoneNumber", error);

            if (error.code === "auth/invalid-app-credential") {
              // Silent fail or log for dev, don't annoy user
              console.warn(
                "Firebase Auth Config Error (localhost/domain mismatch)",
              );
            } else if (
              error.message.includes("blocked all requests from this device") ||
              error.code === "auth/too-many-requests"
            ) {
              showToast("Too many attempts. Please try again later.", "error");
            } else {
              showToast("Error sending OTP. Please check the number.", "error");
            }

            if (window.recaptchaVerifier && window.recaptchaVerifier.clear) {
              window.recaptchaVerifier.clear();
            }
          });
      });

      document
        .getElementById("login-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const otp = getOtpValue();
          if (otp.length !== 6) {
            showToast("Please enter a valid 6-digit OTP", "error");
            return;
          }

          setLoading(verifyOtpBtn, true);

          try {
            if (!verifiedUser) {
              const result = await window.confirmationResult.confirm(otp);
              verifiedUser = result.user;
              console.log("Firebase Verified User:", verifiedUser);
            }

            // Call backend to check if user exists in DB and get details
            const res = await fetch(
              "https://kanha-backend-yfx1.onrender.com/api/login-otp",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ mobile: verifiedUser.phoneNumber }),
              },
            );

            const data = await res.json();

            if (!res.ok) {
              // Handle User Not Found -> Registration Flow
              if (
                res.status === 400 &&
                data.message?.includes("User not found")
              ) {
                // Switch to Registration Step
                stepOtp.classList.add("hidden");
                stepRegister.classList.remove("hidden");

                // Update Header
                headerText.innerHTML = `
                    <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">Complete Profile</h1>
                    <p class="text-gray-300 text-sm">Please tell us a bit about yourself</p>
                `;

                isRegistration = true;
                setLoading(verifyOtpBtn, false);
                return;
              }

              if (res.status === 403 && data.message?.includes("blocked")) {
                showToast("Account blocked by admin.", "error");
              } else {
                showToast(data.message || "Login failed", "error");
              }
              setLoading(verifyOtpBtn, false);
              return;
            }

            // âœ… SUCCESS LOGIN
            showToast("Login successful!", "success");
            setTimeout(() => loginSuccess(data.user), 500);
          } catch (error) {
            console.error(error);
            setLoading(verifyOtpBtn, false);
            showToast("Invalid OTP or Server Error", "error");
          }
        });

      // Handle Registration
      registerBtn.addEventListener("click", async function () {
        const fullname = document.getElementById("fullname").value.trim();
        const gender = document.getElementById("gender").value;

        if (!fullname) {
          showToast("Please enter your full name", "error");
          return;
        }

        if (!gender) {
          showToast("Please select your gender", "error");
          return;
        }

        setLoading(registerBtn, true);

        // Split name
        const names = fullname.split(" ");
        const firstName = names[0];
        const lastName = names.slice(1).join(" ") || "."; // Default dot if no last name

        try {
          const res = await fetch(
            "https://kanha-backend-yfx1.onrender.com/api/signup-otp",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                mobile: verifiedUser.phoneNumber,
                firstName: firstName,
                lastName: lastName,
                gender: gender,
              }),
            },
          );

          const data = await res.json();
          if (!res.ok) {
            showToast(data.message || "Registration failed", "error");
            setLoading(registerBtn, false);
            return;
          }

          showToast("Registration successful!", "success");
          setTimeout(() => loginSuccess(data.user), 500);
        } catch (err) {
          console.error(err);
          setLoading(registerBtn, false);
          showToast("Server Error during registration", "error");
        }
      });

      function loginSuccess(user) {
        localStorage.setItem("user", JSON.stringify(user));

        if (user.role === "admin") {
          window.location.href = "admin.html";
        } else if (user.role === "incharge") {
          window.location.href = "libincharge.html";
        } else if (user.role === "user") {
          window.location.href = "booking.html";
        } else {
          showToast("Unknown role", "error");
        }
      }
    </script>
  </body>
</html>
