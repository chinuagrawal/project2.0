<!doctype html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-MS3QJRDZ7C"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-MS3QJRDZ7C");
    </script>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4a148c" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | Kanha Library</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Poppins", "sans-serif"],
            },
            colors: {
              primary: "#4a148c",
              secondary: "#7c43bd",
              glass: "rgba(255, 255, 255, 0.1)",
            },
            animation: {
              "fade-in-up": "fadeInUp 0.5s ease-out",
              "pulse-slow": "pulse 3s infinite",
            },
            keyframes: {
              fadeInUp: {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      /* Fix for autofill overlap - forces label up when browser autofills */
      input:-webkit-autofill + label,
      input:not(:placeholder-shown) + label {
        top: -1.5rem !important;
        font-size: 0.75rem !important;
        color: #7c43bd !important;
      }

      /* Ensure autofilled input text is visible and consistent */
      input:-webkit-autofill {
        -webkit-box-shadow: 0 0 0 30px #2a2a2a inset !important;
        -webkit-text-fill-color: white !important;
        caret-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
      }

      /* Hide reCAPTCHA badge */
      .grecaptcha-badge {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
      }
    </style>

    <link rel="stylesheet" href="./login.css?v=1.2" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </head>

  <body
    class="bg-gray-900 font-sans min-h-[100dvh] w-full overflow-x-hidden relative flex flex-col justify-center"
  >
    <!-- Background Image with Overlay -->
    <div
      class="fixed inset-0 z-0 w-full h-full bg-cover bg-center bg-no-repeat"
      style="background-image: url(&quot;login-bg.png&quot;)"
    >
      <div class="absolute inset-0 bg-black/60 backdrop-blur-[2px]"></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 flex items-center justify-center h-full px-4">
      <!-- Glassmorphism Card -->
      <div
        class="w-full max-w-md bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl shadow-2xl p-6 md:p-8 animate-fade-in-up transform transition-all hover:scale-[1.01] duration-300"
      >
        <div class="text-center mb-8" id="header-text">
          <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">
            Welcome Back
          </h1>
          <p class="text-gray-300 text-sm">
            Sign in to access your library account
          </p>
        </div>

        <form id="login-form" class="space-y-6">
          <!-- Step 1: Mobile -->
          <div id="step-mobile" class="space-y-6">
            <div class="relative group mt-4">
              <i
                class="ri-smartphone-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors z-10"
              ></i>
              <input
                type="text"
                id="mobile"
                required
                class="block w-full pl-10 pr-3 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-transparent focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all peer"
                placeholder=" "
              />
              <label
                for="mobile"
                class="absolute left-10 top-3 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3 peer-focus:-top-6 peer-focus:text-xs peer-focus:text-secondary peer-not-placeholder-shown:-top-6 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:text-secondary cursor-text pointer-events-none"
              >
                Mobile Number
              </label>
            </div>
            <button
              type="button"
              id="send-otp-btn"
              class="w-full py-3.5 px-4 bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary ring-offset-black"
            >
              Send OTP
            </button>
          </div>

          <!-- Step 2: OTP (Hidden) -->
          <div id="step-otp" class="hidden space-y-6 animate-fade-in-up">
            <div id="otp-inputs" class="flex justify-between gap-2 mt-4">
              <input
                type="text"
                maxlength="1"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="text"
                maxlength="1"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="text"
                maxlength="1"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="text"
                maxlength="1"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="text"
                maxlength="1"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
              <input
                type="text"
                maxlength="1"
                class="w-12 h-12 text-center bg-white/5 border border-white/10 rounded-lg text-white text-xl focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all"
              />
            </div>
            <button
              type="submit"
              id="verify-otp-btn"
              class="w-full py-3.5 px-4 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300"
            >
              Verify & Login
            </button>

            <div class="text-center">
              <button
                id="resend-otp-btn"
                type="button"
                class="text-sm text-gray-400 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Resend OTP in <span id="resend-timer">60</span>s
              </button>
            </div>
          </div>

          <!-- Step 3: Register (Hidden) -->
          <div id="step-register" class="hidden space-y-6 animate-fade-in-up">
            <div class="relative group mt-4">
              <i
                class="ri-user-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors z-10"
              ></i>
              <input
                type="text"
                id="fullname"
                class="block w-full pl-10 pr-3 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-transparent focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all peer"
                placeholder=" "
              />
              <label
                for="fullname"
                class="absolute left-10 top-3 text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3 peer-focus:-top-6 peer-focus:text-xs peer-focus:text-secondary peer-not-placeholder-shown:-top-6 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:text-secondary cursor-text pointer-events-none"
              >
                Full Name
              </label>
            </div>

            <div class="relative group">
              <i
                class="ri-women-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors"
              ></i>
              <select
                id="gender"
                class="block w-full pl-10 pr-3 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition-all appearance-none cursor-pointer"
              >
                <option
                  value=""
                  disabled
                  selected
                  class="bg-gray-800 text-gray-400"
                >
                  Select Gender
                </option>
                <option value="Male" class="bg-gray-800 text-white">
                  Male
                </option>
                <option value="Female" class="bg-gray-800 text-white">
                  Female
                </option>
                <option value="Other" class="bg-gray-800 text-white">
                  Other
                </option>
              </select>
              <div
                class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"
              >
                <i class="ri-arrow-down-s-line text-gray-400"></i>
              </div>
            </div>

            <button
              type="button"
              id="register-btn"
              class="w-full py-3.5 px-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300"
            >
              Complete Registration
            </button>
          </div>

          <!-- Footer Text -->
          <div class="text-center mt-6">
            <p class="text-gray-400 text-sm">
              Need help?
              <a
                href="#"
                class="text-white hover:text-secondary hover:underline transition-colors"
                >Contact Support</a
              >
            </p>
          </div>
        </form>
      </div>
    </div>

    <!-- Hidden Signup Link (kept for backward compatibility logic if any, but visually removed/minimized) -->
    <div style="display: none">
      <a href="./signup.html">Register</a>
    </div>

    <script>
      // TODO: REPLACE WITH YOUR FIREBASE CONFIGURATION
      const firebaseConfig = {
        apiKey: "AIzaSyDhzexdsI1HpCDgkxpxlwO-A6rNAM7ikIQ",
        authDomain: "paprplus-912cd.firebaseapp.com",
        projectId: "paprplus-912cd",
        storageBucket: "paprplus-912cd.firebasestorage.app",
        messagingSenderId: "951367264254",
        appId: "1:951367264254:web:f89d8f8ef715aa9ac502af",
        measurementId: "G-XZWSFKDHFY",
      };

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      // Set language to default device language
      firebase.auth().useDeviceLanguage();

      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
        "send-otp-btn",
        {
          size: "invisible",
          callback: (response) => {
            // reCAPTCHA solved
            // onSignInSubmit();
          },
        },
      );

      const sendOtpBtn = document.getElementById("send-otp-btn");
      const verifyOtpBtn = document.getElementById("verify-otp-btn");
      const registerBtn = document.getElementById("register-btn");
      const stepMobile = document.getElementById("step-mobile");
      const stepOtp = document.getElementById("step-otp");
      const stepRegister = document.getElementById("step-register");
      const headerText = document.getElementById("header-text");
      const otpInputs = document.querySelectorAll("#otp-inputs input");
      const resendOtpBtn = document.getElementById("resend-otp-btn");
      const resendTimerSpan = document.getElementById("resend-timer");
      let resendInterval;

      let isRegistration = false;
      let verifiedUser = null;

      // Handle OTP Inputs Logic (Auto-focus, Backspace)
      otpInputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
          if (e.target.value.length === 1) {
            if (index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }
          }

          // Auto-submit if all fields are filled
          const otp = getOtpValue();
          if (otp.length === 6) {
            verifyOtpBtn.click();
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !e.target.value) {
            if (index > 0) {
              otpInputs[index - 1].focus();
            }
          }
        });

        // Allow only numbers
        input.addEventListener("keypress", function (e) {
          if (e.which < 48 || e.which > 57) {
            e.preventDefault();
          }
        });
      });

      function getOtpValue() {
        let otp = "";
        otpInputs.forEach((input) => {
          otp += input.value;
        });
        return otp;
      }

      function startResendTimer() {
        let timeLeft = 60;
        resendOtpBtn.disabled = true;
        resendTimerSpan.textContent = timeLeft;
        resendOtpBtn.innerHTML = `Resend OTP in <span id="resend-timer">${timeLeft}</span>s`;

        clearInterval(resendInterval);
        resendInterval = setInterval(() => {
          timeLeft--;
          if (document.getElementById("resend-timer")) {
            document.getElementById("resend-timer").textContent = timeLeft;
          }

          if (timeLeft <= 0) {
            clearInterval(resendInterval);
            resendOtpBtn.disabled = false;
            resendOtpBtn.innerHTML = "Resend OTP";
          }
        }, 1000);
      }

      resendOtpBtn.addEventListener("click", function () {
        sendOtpBtn.click();
      });

      sendOtpBtn.addEventListener("click", function () {
        const phoneNumber = document.getElementById("mobile").value.trim();

        if (!phoneNumber) {
          alert("Please enter a mobile number");
          return;
        }

        // Add +91 if not present (assuming India)
        const formattedPhoneNumber = phoneNumber.startsWith("+")
          ? phoneNumber
          : "+91" + phoneNumber;

        const appVerifier = window.recaptchaVerifier;

        firebase
          .auth()
          .signInWithPhoneNumber(formattedPhoneNumber, appVerifier)
          .then((confirmationResult) => {
            window.confirmationResult = confirmationResult;

            // Switch to OTP Step
            stepMobile.classList.add("hidden");
            stepOtp.classList.remove("hidden");

            // Update Header
            headerText.innerHTML = `
                <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">Enter Verification Code</h1>
                <p class="text-gray-300 text-sm">Sent to ${formattedPhoneNumber}</p>
            `;

            // Focus first OTP input
            setTimeout(() => otpInputs[0].focus(), 100);

            // Start Resend Timer
            startResendTimer();
          })
          .catch((error) => {
            console.error("Error during signInWithPhoneNumber", error);
            if (error.code === "auth/invalid-app-credential") {
              alert(
                "Configuration Error: Hostname match not found.\n\nPlease go to Firebase Console -> Authentication -> Settings -> Authorized Domains.\nAdd '127.0.0.1' and 'localhost' to the list.",
              );
            } else if (
              error.message.includes("blocked all requests from this device") ||
              error.code === "auth/too-many-requests"
            ) {
              alert(
                "Access Temporarily Blocked:\n\nWe have detected unusual activity from this device and blocked requests to protect your account.\n\nThis usually happens after too many failed login attempts.\n\nPlease try the following:\n1. Wait for 30-60 minutes before trying again.\n2. Switch to a different network (e.g., use Mobile Data instead of WiFi).\n3. Try logging in from a different browser or device.",
              );
            } else {
              alert("Error sending OTP: " + error.message);
            }

            if (window.recaptchaVerifier && window.recaptchaVerifier.clear) {
              window.recaptchaVerifier.clear();
            }
          });
      });

      document
        .getElementById("login-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const otp = getOtpValue();
          if (otp.length !== 6)
            return alert("Please enter a valid 6-digit OTP");

          try {
            if (!verifiedUser) {
              const result = await window.confirmationResult.confirm(otp);
              verifiedUser = result.user;
              console.log("Firebase Verified User:", verifiedUser);
            }

            // Call backend to check if user exists in DB and get details
            const res = await fetch(
              "https://kanha-backend-yfx1.onrender.com/api/login-otp",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ mobile: verifiedUser.phoneNumber }),
              },
            );

            const data = await res.json();

            if (!res.ok) {
              // Handle User Not Found -> Registration Flow
              if (
                res.status === 400 &&
                data.message?.includes("User not found")
              ) {
                // Switch to Registration Step
                stepOtp.classList.add("hidden");
                stepRegister.classList.remove("hidden");

                // Update Header
                headerText.innerHTML = `
                    <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">Complete Profile</h1>
                    <p class="text-gray-300 text-sm">Please tell us a bit about yourself</p>
                `;

                isRegistration = true;
                return;
              }

              if (res.status === 403 && data.message?.includes("blocked")) {
                alert("❌ " + data.message);
              } else {
                alert(data.message || "Login failed");
              }
              return;
            }

            // ✅ SUCCESS LOGIN
            loginSuccess(data.user);
          } catch (error) {
            console.error(error);
            alert("Invalid OTP or Server Error");
          }
        });

      // Handle Registration
      registerBtn.addEventListener("click", async function () {
        const fullname = document.getElementById("fullname").value.trim();
        const gender = document.getElementById("gender").value;

        if (!fullname) {
          alert("Please enter your full name");
          return;
        }

        if (!gender) {
          alert("Please select your gender");
          return;
        }

        // Split name
        const names = fullname.split(" ");
        const firstName = names[0];
        const lastName = names.slice(1).join(" ") || "."; // Default dot if no last name

        try {
          const res = await fetch(
            "https://kanha-backend-yfx1.onrender.com/api/signup-otp",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                mobile: verifiedUser.phoneNumber,
                firstName: firstName,
                lastName: lastName,
                gender: gender,
              }),
            },
          );

          const data = await res.json();
          if (!res.ok) {
            alert(data.message || "Registration failed");
            return;
          }

          loginSuccess(data.user);
        } catch (err) {
          console.error(err);
          alert("Server Error during registration");
        }
      });

      function loginSuccess(user) {
        localStorage.setItem("user", JSON.stringify(user));

        if (user.role === "admin") {
          window.location.href = "admin.html";
        } else if (user.role === "incharge") {
          window.location.href = "libincharge.html";
        } else if (user.role === "user") {
          window.location.href = "booking.html";
        } else {
          alert("Unknown role");
        }
      }
    </script>
  </body>
</html>
