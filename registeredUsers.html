<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <meta charset="UTF-8" />
  <title>Registered Users - Kanha Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* (keep your existing styles) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 30px 15px; color: #333; }
    h2 { font-size: 26px; font-weight: bold; margin-bottom: 20px; color: #2c3e50; text-align: center; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    th { background-color: #2c3e50; color: white; text-align: left; padding: 12px 15px; font-size: 15px; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 14px; word-break: break-word; }
    tr:hover { background-color: #f9f9f9; }
    button.action-btn { margin-left:8px; padding:6px 10px; border-radius:4px; border: none; cursor: pointer; }
    button.delete { background:#e74c3c; color:#fff; }
    button.block { background:#f1c40f; color:#111; }
    button.unblock { background:#2ecc71; color:#fff; }
    @media (max-width:768px){ /* keep mobile styles as you have */table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        padding: 12px;
      }

      td {
        position: relative;
        padding-left: 50%;
        text-align: left;
        border: none;
        border-bottom: 1px solid #eee;
      }

      td::before {
        content: attr(data-label);
        position: absolute;
        left: 15px;
        top: 12px;
        font-weight: bold;
        color: #666;
        font-size: 13px;
        white-space: nowrap;
      }

      td:last-child {
        border-bottom: none;
      }
    } 
  </style>
</head>
<body>
  <h2>Registered Users</h2>
  <table id="users-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Gender</th>
        <th>Mobile</th>
        <th>Email</th>
        <th>Role</th>
        <th>Seat No.</th>
        <th>Registered On</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- rows injected here -->
    </tbody>
  </table>

  <script>
    // Set API base to your backend URL
    const API_BASE = 'https://kanha-backend-yfx1.onrender.com';

    // simple admin guard (optional)
   const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== "admin") {
      alert("Access denied! Admins only.");
      window.location.href = "login.html";
    }

    // Fetch and render users
    async function fetchUsers() {
      try {
        const bookingRes = await fetch(`${API_BASE}/api/bookings`);
        const bookings = await bookingRes.json();
        // Map latest booking per user
const latestByEmail = {};

bookings.forEach(b => {
  if (!latestByEmail[b.email] || new Date(b.createdAt) > new Date(latestByEmail[b.email].createdAt)) {
    latestByEmail[b.email] = b;
  }
});

        const res = await fetch(`${API_BASE}/api/users`);
        if (!res.ok) throw new Error('Failed to fetch users');
        const users = await res.json();

        users.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        const tbody = document.querySelector('#users-table tbody');
        tbody.innerHTML = '';

        users.forEach((u, i) => {
          const createdAt = new Date(u.createdAt || 0);
          const dateStr = !isNaN(createdAt) ? createdAt.toLocaleString('en-GB', {
            day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:false
          }) : 'N/A';

          const phone = u.mobile || '';
          const whatsappLink = `https://wa.me/91${phone}`;
          const callLink = `tel:${phone}`;
          const smsLink = `sms:${phone}`;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="#">${i+1}</td>
            <td data-label="Name">${escapeHtml(u.firstName || '')} ${escapeHtml(u.lastName || '')}</td>
            <td data-label="Gender">${escapeHtml(u.gender || '')}</td>
            <td data-label="Mobile">
              ${escapeHtml(phone)}<br/>
              <a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp" style="color:#25D366;"></i></a>
              <a href="${callLink}"><i class="fas fa-phone" style="color:#2c3e50; margin-left:8px;"></i></a>
              <a href="${smsLink}"><i class="fas fa-comment-dots" style="color:#007bff; margin-left:8px;"></i></a>
            </td>
            <td data-label="Email">${escapeHtml(u.email || '')}</td>
            <td data-label="Role">${escapeHtml(u.role || '')}</td>

<td data-label="Seat No.">
  ${
    latestByEmail[u.email]
      ?  + latestByEmail[u.email].seatId
      : "<span style='color:red;'>Not Booked</span>"
  }
</td>


            <td data-label="Registered On">${dateStr}</td>
            <td data-label="Actions">
              <button class="action-btn delete" onclick="deleteUser('${u._id}', this)">üóëÔ∏è Delete</button>
              <button class="action-btn ${u.blocked ? 'unblock' : 'block'}" 
                      onclick="toggleBlock('${u._id}', ${u.blocked ? 'true' : 'false'}, this)">
                ${u.blocked ? '‚úÖ Unblock' : 'üö´ Block'}
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('Failed to load users.');
      }
    }

    // escape to avoid HTML injection
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // Delete user
    async function deleteUser(userId, btn) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        const res = await fetch(`${API_BASE}/api/users/${userId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        // remove row
        btn.closest('tr').remove();
        alert('User deleted');
      } catch (err) {
        console.error(err);
        alert('Failed to delete user');
      }
    }

    // Toggle block/unblock
    async function toggleBlock(userId, currentlyBlocked, btn) {
      const wantBlock = !currentlyBlocked;
      const confirmMsg = wantBlock ? 'Block this user from logging in?' : 'Unblock this user?';
      if (!confirm(confirmMsg)) return;

      try {
        const res = await fetch(`${API_BASE}/api/users/${userId}/block`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ blocked: wantBlock })
        });

        const data = await res.json();
        if (!res.ok) {
          const msg = data?.message || 'Failed to update';
          throw new Error(msg);
        }

        // Update row UI instantly
        const statusBtn = btn;
        statusBtn.dataset.blocked = String(wantBlock);
        statusBtn.textContent = wantBlock ? '‚úÖ Unblock' : 'üö´ Block';
        statusBtn.classList.toggle('block', !wantBlock);
        statusBtn.classList.toggle('unblock', wantBlock);

        alert(data.message || (wantBlock ? 'User blocked' : 'User unblocked'));
      } catch (err) {
        console.error(err);
        alert(err.message || 'Error updating user status');
      }
    }

    // initial load
    fetchUsers();
  </script>
</body>
</html>
