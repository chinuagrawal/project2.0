<!doctype html>
<html lang="en">
  <head>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4a148c" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seat Status & PDF Export</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      /* Global styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: #f0f0f5;
        padding: 20px;
      }

      /* Heading */
      h1 {
        text-align: center;
        color: #4a148c;
        margin-bottom: 20px;
        font-size: 24px;
      }

      /* Control buttons */
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }

      button {
        padding: 10px 18px;
        background: #7b1fa2;
        border: none;
        color: white;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }

      button:hover {
        background: #6a1b9a;
      }

      /* Seat map grid */
      .seat-map {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(35px, 1fr));
        gap: 6px;
        max-width: 320px;
        margin: auto;
      }

      .seat {
        width: 35px;
        height: 35px;
        border-radius: 6px;
        line-height: 35px;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #ccc;
        background: white;
        transition: all 0.2s;
      }

      .seat:hover {
        background: #f1f1f1;
      }

      .selected {
        border: 2px solid #2196f3;
        background: #e3f2fd;
      }

      /* Details panel */
      .details-panel {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0px 0 10px rgba(0, 0, 0, 0.08);
        margin-top: 30px;
        max-width: 1000px;
        margin-left: auto;
        margin-right: auto;
        overflow-x: auto;
      }

      /* Table styling */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
        vertical-align: middle;
      }

      th {
        background: #f9f9f9;
        font-weight: 600;
      }

      td button {
        background: #d32f2f;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
      }

      td button:hover {
        background: #b71c1c;
      }

      /* Responsive adjustments */
      /* ---- MOBILE CARD LAYOUT ---- */
      @media (max-width: 650px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }

        thead {
          display: none;
        }

        tr {
          background: #fff;
          margin-bottom: 12px;
          padding: 12px;
          border-radius: 12px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        td {
          border: none;
          padding: 6px 0;
          display: flex;
          justify-content: space-between;
          font-size: 14px;
        }

        td::before {
          content: attr(data-label);
          font-weight: 600;
          color: #555;
        }

        .icon-btn {
          font-size: 20px !important;
        }

        .details-panel {
          padding: 12px;
        }
      }

      /* Make details panel mobile-friendly */

      /* Limit table column width on mobile */
      @media (max-width: 600px) {
        table th,
        table td {
          font-size: 12px;
          padding: 6px;
          white-space: nowrap;
        }

        .icon-btn {
          font-size: 20px;
          padding: 6px;
        }
      }

      /* Icon button styles */
      .icon-btn {
        font-size: 22px;
        cursor: pointer;
        text-decoration: none;
        padding: 5px;
        border-radius: 6px;
        display: inline-block;
      }

      .icon-call {
        color: #1976d2; /* blue */
      }

      .icon-wa {
        color: #25d366; /* WhatsApp green */
      }
    </style>
  </head>
  <body>
    <div class="seat-map" id="seat-map"></div>

    <div class="details-panel" id="details-panel">
      <h2>Select a seat above</h2>
    </div>

    <script>
      let dataLoaded = false;
      let lastSelectedSeat = null;

      // const user = JSON.parse(localStorage.getItem("user"));
      // if (!user || user.role !== "incharge") {
      //   alert("Access denied! Incharge only.");
      //   window.location.href = "login.html";
      // }

      // ---- GLOBAL ----
      const totalSeats = 34;
      const seatMap = document.getElementById("seat-map");
      const detailsPanel = document.getElementById("details-panel");
      let bookings = [];
      let usersByEmail = {};

      // ---- SHOW SEATS IMMEDIATELY ----
      renderSeatMap();
      detailsPanel.innerHTML = `<h2>Loading data...</h2>`;

      // ---- LOAD BOOKING + USER DATA IN BACKGROUND ----
      window.onload = () => {
        loadAll().then(() => {
          dataLoaded = true;

          // If seat clicked before load finished, show its details now
          if (lastSelectedSeat) {
            showDetails(lastSelectedSeat);
          } else {
            detailsPanel.innerHTML = `<h2>Select a seat above</h2>`;
          }
        });
      };

      async function loadAll() {
        const [bookingRes, usersRes] = await Promise.all([
          fetch(`https://kanhabackend.onrender.com/api/bookings`),
          fetch(`https://kanhabackend.onrender.com/api/users`),
        ]);

        bookings = await bookingRes.json();
        const users = await usersRes.json();

        users.forEach((u) => {
          usersByEmail[u.email] = {
            name: `${u.firstName || ""} ${u.lastName || ""}`.trim(),
            email: u.email,
            mobile: u.mobile || "N/A",
          };
        });
      }

      // ---- RENDER SEATS ----
      function renderSeatMap() {
        seatMap.innerHTML = "";

        for (let i = 1; i <= totalSeats; i++) {
          const seat = `${i}`;
          const el = document.createElement("div");
          el.className = "seat";
          el.dataset.seat = seat;
          el.innerText = i;

          el.onclick = () => {
            // highlight UI immediately
            document
              .querySelectorAll(".seat")
              .forEach((s) => s.classList.remove("selected"));
            el.classList.add("selected");

            // store selected seat
            lastSelectedSeat = seat;

            if (!dataLoaded) {
              detailsPanel.innerHTML = `<h2>Seat ${seat}</h2><p>Loading booking data...</p>`;
              return;
            }

            showDetails(seat);
          };

          seatMap.appendChild(el);
        }
      }

      // ---- SHOW SEAT DETAILS ----
      function showDetails(seat) {
        const sb = bookings.filter((b) => b.seatId === seat);

        if (!sb.length) {
          detailsPanel.innerHTML = `<h2>${seat}</h2><p>No bookings.</p>`;
          return;
        }

        const grouped = {};
        sb.forEach((b) => {
          const user = usersByEmail[b.email] || {
            name: b.email,
            email: b.email,
            mobile: "N/A",
          };
          const key = `${b.email}_${b.shift}`;
          grouped[key] = grouped[key] || {
            name: user.name,
            email: user.email,
            mobile: user.mobile,
            shift: b.shift,
            pay: b.paymentMode,
            dates: [],
          };
          grouped[key].dates.push(b.date);
        });

        let html = `
    <h2>Seat Number - ${seat}</h2>
    <table>
      <thead>
        <tr>
          <th>User</th>
          
          
          <th>Shift</th>
          <th>Payment</th>
          <th>From</th>
          <th>To</th>
          <th>Days</th>
          
        
        </tr>
      </thead>
      <tbody>
  `;

        Object.values(grouped).forEach((entry) => {
          entry.dates.sort();
          const mobile = entry.mobile.replace(/\D/g, "");

          html += `
<tr>
  <td data-label="User">${entry.name}</td>
  
  
  <td data-label="Shift">${entry.shift}</td>
  <td data-label="Payment">${entry.pay || "Online"}</td>
  <td data-label="From">${entry.dates[0]}</td>
  <td data-label="To">${entry.dates.at(-1)}</td>
  <td data-label="Days">${calculateDays(entry.dates[0], entry.dates.at(-1))}</td>

  

  
 
</tr>
`;
        });

        html += `</tbody></table>`;
        detailsPanel.innerHTML = html;
      }

      async function deleteBooking(seatId, email, shift) {
        if (!confirm("Are you sure you want to delete this booking?")) return;

        const res = await fetch(
          "https://kanhabackend.onrender.com/api/delete-bookings",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ seatId, email, shift }),
          },
        );

        const result = await res.json();

        if (result.success) {
          alert("Deleted successfully");
          loadAll().then(() => showDetails(seatId));
        } else {
          alert("Delete failed");
        }
      }

      function calculateDays(from, to) {
        const start = new Date(from);
        const end = new Date(to);
        return Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
      }
    </script>
  </body>
</html>
