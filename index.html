<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Seat Booking</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./index.css">
  
</head>
<body>
  <header>
    <h2>Study Room Library</h2>
    <nav>
      <a href="#home">Home</a>
      <a href="#about">About</a>
      <a href="./booking.html">Book Now</a>
      <a href="#contact">Contact</a>
      <span id="user-section">
        <a href="./login.html" id="login-link">Login</a>
      </span>
    </nav>
  </header>

  <h3 id="welcome-message" class="welcome-text"></h3>

  <section class="home" id="home">
    <div class="carousel">
      <div class="carousel-images">
        <img src="images/1.webp" alt="Image 1">
        <img src="images/2.webp" alt="Image 2">
        <img src="images/3.webp" alt="Image 3">
        <img src="images/4.webp" alt="Image 4">
        <img src="images/5.webp" alt="Image 5">
      </div>
    </div>
<div id="confirmation-modal" class="modal hidden">
  <div class="modal-content">
    <h2>‚úÖ Booking Confirmed!</h2>
    <p id="confirmation-details"></p>
    <button id="close-modal">OK</button>
  </div>
</div>
    <section id="my-bookings" style="display:none; padding: 20px;">
      <h2>üìö My Booked Seats</h2>
      <div id="booking-list" class="booking-list"></div>
    </section>

    <h1>Welcome to Our Study Room Library</h1>
     <div style="margin-top: 40px; text-align: center;">
  <h2>üìÖ Check Seat Availability</h2>
  <h3>Select Date  üëá</h3>
  <input type="date" id="calendar-date" style="padding: 8px; font-size: 16px; margin-bottom: 15px;" />
  <div id="calendar-seat-map" style="display: flex; flex-wrap: wrap; justify-content: center; margin-top: 10px;"></div>
  <div style="margin-top: 15px;">
    
    <div><span style="background-color: red; color: white; padding: 5px 10px; margin: 4px; border-radius: 4px;">Fully Booked</span>
    <span style="background-color: orange; padding: 5px 10px; margin: 4px; border-radius: 4px;">AM Booked</span>
    <span style="background-color: purple; color: white; padding: 5px 10px; margin: 4px; border-radius: 4px;">PM Booked</span>
    <span style="background-color: rgb(237, 234, 234); color: black;padding: 5px 10px; margin: 4px; border-radius: 4px; border: 1px solid #faf3f3;">Available</span></div>
  </div>
</div>
    <button class="book-now-btn" type="button">Book Now</button>

   
    </section>
   


 

  
  <section id="about">
    <h2>About Us</h2>
    <p>We offer a peaceful self-study library environment with 34 seats available. Choose from full-day (‚Çπ800) or half-day (‚Çπ600) shifts to suit your schedule. Perfect for students, exam preparation, or quiet work.</p>
  </section>

  <section id="contact">
    <h2>Contact Us</h2>
    <p>Email: studyroom@example.com</p>
    <p>Phone: +91 9876543210</p>
  </section>

  <footer>
    <p>&copy; 2025 Study Room Library. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE = 'project20-production-e7f5.up.railway.app/api';

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }

    function updateUserUI() {
      const userData = localStorage.getItem("user");
      const userSection = document.getElementById("user-section");
      if (userData) {
        const user = JSON.parse(userData);
        userSection.innerHTML = `<span>üë§ ${user.firstName || user.email} <button onclick="logout()">Logout</button></span>`;
      } else {
        userSection.innerHTML = `<a href="./login.html" id="login-link">Login</a>`;
      }
    }

    function logout() {
      localStorage.removeItem("user");
      updateUserUI();
      location.reload();
    }

    function groupBookings(bookings) {
      const groups = [];
      bookings.sort((a, b) => {
        if (a.seatId !== b.seatId) return a.seatId.localeCompare(b.seatId);
        if (a.shift !== b.shift) return a.shift.localeCompare(b.shift);
        return new Date(a.date) - new Date(b.date);
      });

      for (let i = 0; i < bookings.length; i++) {
        const current = bookings[i];
        const lastGroup = groups[groups.length - 1];
        const currentDate = new Date(current.date);
        const lastDate = lastGroup ? new Date(lastGroup.end) : null;

        if (
          lastGroup &&
          lastGroup.seatId === current.seatId &&
          lastGroup.shift === current.shift &&
          currentDate.getTime() === lastDate.getTime() + 86400000
        ) {
          lastGroup.end = current.date;
        } else {
          groups.push({
            seatId: current.seatId,
            shift: current.shift,
            start: current.date,
            end: current.date,
          });
        }
      }
      return groups;
    }

    async function loadBookings() {
      const userData = localStorage.getItem("user");
      if (!userData) return;
      const user = JSON.parse(userData);

      try {
        const res = await fetch(`${API_BASE}/bookings?email=${user.email}`);
        const bookings = await res.json();
        const section = document.getElementById("my-bookings");
        const list = document.getElementById("booking-list");

        if (Array.isArray(bookings) && bookings.length > 0) {
          section.style.display = "block";
          const grouped = groupBookings(bookings);
          list.innerHTML = grouped.map(b => `
            <div class="booking-card">
              <p><strong>Seat:</strong> ${b.seatId}</p>
              <p><strong>From:</strong> ${formatDate(b.start)}</p>
              <p><strong>To:</strong> ${formatDate(b.end)}</p>
              <p><strong>Shift:</strong> ${b.shift.toUpperCase()}</p>
            </div>
          `).join('');
        }
      } catch (err) {
        console.error("Error loading bookings:", err);
      }
    }

    async function loadAvailability(date) {
      if (!date) return;

      try {
        const response = await fetch(`${API_BASE}/bookings?date=${date}`);
        const bookings = await response.json();

        const seatStatus = {};

        bookings.forEach(b => {
          if (!seatStatus[b.seatId]) seatStatus[b.seatId] = [];
          seatStatus[b.seatId].push(b.shift.toUpperCase());
        });

        const seatMap = document.getElementById("calendar-seat-map");
        seatMap.innerHTML = "";

        for (let i = 1; i <= 34; i++) {
          const seatId = `S${i}`;
          const shifts = seatStatus[seatId] || [];

          let bg = "white";
          if (shifts.includes("FULL") || (shifts.includes("AM") && shifts.includes("PM"))) {
            bg = "red";
          } else if (shifts.includes("PM") && !shifts.includes("AM")) {
            bg = "purple";
          } else if (shifts.length === 1) {
            bg = "orange";
          }

          const div = document.createElement("div");
          div.className = "seat-box";
          div.textContent = seatId;
          div.style.backgroundColor = bg;
          div.style.color = (bg === "purple" || bg === "red") ? "white" : "black";
          seatMap.appendChild(div);
        }
      } catch (err) {
        console.error("Failed to load seat availability:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      let currentIndex = 0;
      const images = document.querySelectorAll('.carousel-images img');
      const totalImages = images.length;
      const carousel = document.querySelector('.carousel-images');

      function showNextImage() {
        currentIndex = (currentIndex + 1) % totalImages;
        carousel.style.transform = `translateX(-${currentIndex * 100}vw)`;
      }

      setInterval(showNextImage, 4000);

      updateUserUI();
      loadBookings();

      const bookNowBtn = document.querySelector(".book-now-btn");
      bookNowBtn.addEventListener("click", () => {
        const user = localStorage.getItem("user");
        if (!user) {
          alert("Please log in first.");
          window.location.href = "login.html";
        } else {
          window.location.href = "booking.html";
        }
      });

      const welcome = document.getElementById("welcome-message");
      const userData = localStorage.getItem("user");
      if (userData) {
        const user = JSON.parse(userData);
        welcome.textContent = `Welcome, ${user.firstName || ''} ${user.lastName || ''}`.trim();
      }

      const dateInput = document.getElementById("calendar-date");

// Set today's date in YYYY-MM-DD format
const today = new Date().toISOString().split("T")[0];
dateInput.value = today;

// Load today's availability immediately
loadAvailability(today);

// Listen for date change
dateInput.addEventListener("change", (e) => {
  // Show modal if redirected from booking page
const params = new URLSearchParams(window.location.search);
if (params.get('success') === '1') {
  const seatId = params.get('seatId');
  const shift = params.get('shift');
  const startDate = params.get('startDate');
  const endDate = params.get('endDate');
  showConfirmationModal(seatId, shift, startDate, endDate);
}

  const selectedDate = e.target.value;
  loadAvailability(selectedDate);
});

    });

  function showConfirmationModal(seatId, shift, startDate, endDate) {
  const modal = document.getElementById('confirmation-modal');
  const details = document.getElementById('confirmation-details');
  const closeBtn = document.getElementById('close-modal');

  details.innerHTML = `
    Seat <strong>${seatId}</strong> booked for <strong>${shift}</strong> shift<br>
    From <strong>${startDate}</strong> to <strong>${endDate}</strong>.
  `;

  modal.classList.remove('hidden');

  closeBtn.onclick = () => {
    modal.classList.add('hidden');
    window.location.href = 'index.html'; // üîÅ Redirect and reload to show updated seat
  };
}
  
  </script>
  <div id="confirmation-modal" class="modal hidden">
  <div class="modal-content">
    <h2>‚úÖ Booking Confirmed!</h2>
    <p id="confirmation-details"></p>
    <button id="close-modal">OK</button>
  </div>
</div>

</body>
</html>
