<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="/manifest.json">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<meta name="theme-color" content="#4a148c">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanha Library Seat Booking - best library in kota</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./index.css?v=1.0.10">
  

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MS3QJRDZ7C"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MS3QJRDZ7C');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9442859388560602"
     crossorigin="anonymous"></script>
</head>
<body>
  
  <header>
    <h2>Kanha Library</h2>
    
    <nav>
      <span id="user-section">
      <a href="./login.html" id="login-link">Login</a>
      </span>
      <a href="#home">Home</a>
      <a href="#about">About</a>
      <a href="./booking.html">Book Now</a>
      <a href="#contact">Contact</a>
      <a href="./policies.html">Policies</a>
      <a href="./admin.html">Admin</a>

      
    </nav>
  </header>

  <span class="credit-text">Website made by Chinmay Agrawal | contact no. 7976769514</span>
  <h3 id="welcome-message" class="welcome-text"></h3>

  <section class="home" id="home">
    <div class="carousel">
      <div class="carousel-images">
       
        
        <img src="images/3.jpg" alt="Image 3">
        <img src="images/4.jpg" alt="Image 4">
         <img src="images/1.jpg" alt="Image 1">
        
         
      </div>
    </div>
 
<div id="confirmation-modal" class="modal hidden">
  <div class="modal-content">
    <h2>âœ… Booking Confirmed!</h2>
    <p id="confirmation-details"></p>
    <button id="close-modal">OK</button>
  </div>
</div>
    <section id="my-bookings" style="display:none; padding: 20px;">
      <h2>ğŸ“š My Booked Seats</h2>
      <div id="booking-list" class="booking-list"></div>
    </section>
    <section id="reviews">
  
<script defer async src='https://cdn.trustindex.io/loader.js?7bdcaac50e9055797b76105107e'></script>
 
</section>


    <h1>Welcome to Our Kanha Library</h1>
     <div style="margin-top: 40px; text-align: center;">
  <h2>ğŸ“… Check Seat Availability</h2>
  <h3>Select Date  ğŸ‘‡</h3>
  <input type="date" id="calendar-date" style="padding: 8px; font-size: 16px; margin-bottom: 15px;" />
   <div class="seat-layout-container">
        <div class="fans-top">
          <div class="fan-icon">ğŸŒ€ Fan</div>
          <div class="fan-icon">ğŸŒ€ Fan</div>
        </div>
        <div class="seat-layout">
          <br>
          <div class="row" id="row3"></div>
          <div class="row" id="row2"></div>
          <br>
          <div class="row" id="row1"></div>
        </div>
        <div class="fan-bottom">
          <div class="fan-icon">ğŸŒ€ Fan</div>
          <div class="fan-icon">ğŸŒ€ Fan</div>
          <div class="fan-icon">ğŸŒ€ Fan</div>
        </div>
      </div>
  <div class="legend-container">
  <div class="legend-item legend-full-booked">Fully Booked</div>
  <div class="legend-item legend-am-booked">AM Booked</div>
  <div class="legend-item legend-pm-booked">PM Booked</div>
  <div class="legend-item legend-available">Available</div>
</div>

    <button class="book-now-btn" type="button">Book Now</button>

   
    </section>
   


 <button id="installBtn" style="display: none;" class="install-app-btn">
  <img src="icon-192.png" alt="App Icon" class="install-icon">
  Download KanhaLibrary App
</button>

  
  <section id="about">
  <p>
  <h3>ğŸ•’ Library Timings & Charges</h3>
  <ul style="list-style: none; padding-left: 0; font-size: 1.1rem;">
    <li><strong>Morning Shift:</strong> 6:00 AM - 2:00 PM â€” <span style="color: #cec002;">â‚¹600</span></li>
    <li><strong>Evening Shift:</strong> 2:00 PM - 10:00 PM â€” <span style="color: #cec002;">â‚¹600</span></li>
    <li><strong>Full Day:</strong> 6:00 AM - 10:00 PM â€” <span style="color: #cec002;">â‚¹800</span></li>
  </ul>
  </p>
<br>
  <h2>About Us</h2>
  <p>We offer a peaceful self-study library environment with 34 seats available. Perfect for students, exam preparation, or quiet work.</p>
  <p>We aim to provide a peaceful and accessible study environment for all students and self-learners. With simple seat booking, secure online payments, and instant confirmations, your library experience is now smoother than ever.</p>
</section>

<section id="contact">
  <h2>Contact Us</h2>
  <p>Email: thechinmayagrawal@gmail.com</p>
  <p>Phone: +91 7976769514</p>
  <p>Phone: +91 9828130420</p>

  <h3>ğŸ“ Our Location</h3>
  <div style="width: 100%; max-width: 600px; margin: 0 auto;">
   
    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d907.5630559108914!2d75.88883464410213!3d25.17316652253965!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x396f9b7b1da4bf35%3A0x3a4c8581d3a9bbff!2sKanha%20Library!5e0!3m2!1sen!2sin!4v1752380422217!5m2!1sen!2sin" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    
  </div>
</section>
<script defer async src='https://cdn.trustindex.io/loader-cert.js?500a16b50c895583bc964b0462d'></script>

  <footer>
  <p>&copy; 2025 Kanha Library. All rights reserved.</p>
  <p style="font-size: 0.9rem; color: #aaa;">Website made by Chinmay Agrawal</p>
</footer>


  <script>
    if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(() => console.log('âœ… Service Worker Registered'))
    .catch(err => console.error('Service Worker Failed:', err));
}

    const API_BASE = 'https://kanha-backend-bw7a.onrender.com/api';

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }

    function updateUserUI() {
      const userData = localStorage.getItem("user");
      const userSection = document.getElementById("user-section");
      if (userData) {
        const user = JSON.parse(userData);
        userSection.innerHTML = `<span>ğŸ‘¤ ${user.firstName || user.email} <button onclick="logout()">Logout</button></span>`;
      } else {
        userSection.innerHTML = `<a href="./login.html" id="login-link">Login</a>`;
      }
    }

    function logout() {
      localStorage.removeItem("user");
      updateUserUI();
      location.reload();
    }

    function groupBookings(bookings) {
      const groups = [];
      bookings.sort((a, b) => {
        if (a.seatId !== b.seatId) return a.seatId.localeCompare(b.seatId);
        if (a.shift !== b.shift) return a.shift.localeCompare(b.shift);
        return new Date(a.date) - new Date(b.date);
      });

      for (let i = 0; i < bookings.length; i++) {
        const current = bookings[i];
        const lastGroup = groups[groups.length - 1];
        const currentDate = new Date(current.date);
        const lastDate = lastGroup ? new Date(lastGroup.end) : null;

        if (
          lastGroup &&
          lastGroup.seatId === current.seatId &&
          lastGroup.shift === current.shift &&
          currentDate.getTime() === lastDate.getTime() + 86400000
        ) {
          lastGroup.end = current.date;
        } else {
          groups.push({
            seatId: current.seatId,
            shift: current.shift,
            start: current.date,
            end: current.date,
          });
        }
      }
      return groups;
    }

    async function loadBookings() {
      const userData = localStorage.getItem("user");
      if (!userData) return;
      const user = JSON.parse(userData);

      try {
        const res = await fetch(`${API_BASE}/bookings?email=${user.email}`);
        const bookings = await res.json();
        const section = document.getElementById("my-bookings");
        const list = document.getElementById("booking-list");

        if (Array.isArray(bookings) && bookings.length > 0) {
          section.style.display = "block";
          const grouped = groupBookings(bookings);
         
          list.innerHTML = grouped.map(b => {
  const today = new Date().toISOString().split('T')[0];
  const isExtendable = new Date(b.end) >= new Date(today);
  return `
    <div class="booking-card">
      <p><strong>Seat:</strong> ${b.seatId}</p>
      <p><strong>From:</strong> ${formatDate(b.start)}</p>
      <p><strong>To:</strong> ${formatDate(b.end)}</p>
      <p><strong>Shift:</strong> ${b.shift.toUpperCase()}</p>
      ${isExtendable ? `<button class="extend-btn" 
        data-seat="${b.seatId}" 
        data-shift="${b.shift}" 
        data-from="${b.start}" 
        data-to="${b.end}">Extend</button>` : ''}
    </div>
  `;
}).join('');
document.querySelectorAll(".extend-btn").forEach(btn => {
  btn.addEventListener("click", async (e) => {
    const seatId = e.target.dataset.seat;
    const shift = e.target.dataset.shift;
    const fromDate = e.target.dataset.from;
    const toDate = e.target.dataset.to;

    // Check extend availability
    try {
      const res = await fetch(`${API_BASE}/extend/check?seatId=${seatId}&shift=${shift}&fromDate=${fromDate}&toDate=${toDate}&email=${user.email}`);

      const data = await res.json();

      if (!data.canExtend) {
        alert("âš ï¸ Cannot extend: seat already booked for future dates.");
        return;
      }

      // Redirect to booking page with locked parameters
      window.location.href = `booking.html?extend=1&seatId=${seatId}&shift=${shift}&fromDate=${fromDate}&toDate=${toDate}`;
    } catch (err) {
      console.error("Failed to check extension availability:", err);
      alert("Server error while checking extend eligibility.");
    }
  });
});



        }
      } catch (err) {
        console.error("Error loading bookings:", err);
      }
    }

    function renderSeatLayout() {
  const rows = [
    { id: 'row1', count: 12 },
    { id: 'row2', count: 11 },
    { id: 'row3', count: 11 },
  ];

  let seatCounter = 1;

  rows.forEach(row => {
    const container = document.getElementById(row.id);
    if (!container) return;

    if (row.id === 'row2') {
      const leftAC = document.createElement('div');
      leftAC.className = 'ac-icon';
      leftAC.textContent = 'â„ï¸ AC';
      container.appendChild(leftAC);
    }

    for (let i = 0; i < row.count; i++) {
      const div = document.createElement('div');
      div.className = 'seat-box';
      div.textContent = `S${seatCounter}`;
      container.appendChild(div);
      seatCounter++;
    }

    if (row.id === 'row2') {
      const rightAC = document.createElement('div');
      rightAC.className = 'ac-icon';
      rightAC.textContent = 'â„ï¸ AC';
      container.appendChild(rightAC);
    }
  });
}


   async function loadAvailability(date) {
  if (!date) return;
  const API_BASE = 'https://kanha-backend-bw7a.onrender.com/api';

  try {
    const response = await fetch(`${API_BASE}/bookings?date=${date}`);
    const bookings = await response.json();

    const seatStatus = {};
    bookings.forEach(b => {
      if (!seatStatus[b.seatId]) seatStatus[b.seatId] = [];
      seatStatus[b.seatId].push(b.shift.toUpperCase());
    });

    const seats = document.querySelectorAll('.seat-box');
    seats.forEach(seat => {
      const seatId = seat.textContent.trim();
      const shifts = seatStatus[seatId] || [];

      let bg = "white";
      if (shifts.includes("FULL") || (shifts.includes("AM") && shifts.includes("PM"))) {
        bg = "red";
      } else if (shifts.includes("PM") && !shifts.includes("AM")) {
        bg = "purple";
      } else if (shifts.length === 1) {
        bg = "orange";
      }

      seat.style.backgroundColor = bg;
      seat.style.color = (bg === "purple" || bg === "red") ? "white" : "black";
    });
  } catch (err) {
    console.error("Failed to load seat availability:", err);
  }
}


    document.addEventListener("DOMContentLoaded", () => {
      renderSeatLayout();
      let currentIndex = 0;
      const images = document.querySelectorAll('.carousel-images img');
      const totalImages = images.length;
      const carousel = document.querySelector('.carousel-images');

      function showNextImage() {
        currentIndex = (currentIndex + 1) % totalImages;
        carousel.style.transform = `translateX(-${currentIndex * 100}vw)`;
      }

      setInterval(showNextImage, 4000);

      updateUserUI();
      loadBookings();

      const bookNowBtn = document.querySelector(".book-now-btn");
      bookNowBtn.addEventListener("click", () => {
        const user = localStorage.getItem("user");
        if (!user) {
          alert("Please log in first.");
          window.location.href = "login.html";
        } else {
          window.location.href = "booking.html";
        }
      });

      const welcome = document.getElementById("welcome-message");
      const userData = localStorage.getItem("user");
      if (userData) {
        const user = JSON.parse(userData);
        welcome.textContent = `Welcome, ${user.firstName || ''} ${user.lastName || ''}`.trim();
      }

      const dateInput = document.getElementById("calendar-date");

// Set today's date in YYYY-MM-DD format
const today = new Date().toISOString().split("T")[0];
dateInput.value = today;

// Load today's availability immediately
loadAvailability(today);

// Listen for date change
dateInput.addEventListener("change", (e) => {
  // Show modal if redirected from booking page
const params = new URLSearchParams(window.location.search);
if (params.get('success') === '1') {
  const seatId = params.get('seatId');
  const shift = params.get('shift');
  const startDate = params.get('startDate');
  const endDate = params.get('endDate');
  showConfirmationModal(seatId, shift, startDate, endDate);
}

  const selectedDate = e.target.value;
  loadAvailability(selectedDate);
});

    });

  function showConfirmationModal(seatId, shift, startDate, endDate) {
  const modal = document.getElementById('confirmation-modal');
  const details = document.getElementById('confirmation-details');
  const closeBtn = document.getElementById('close-modal');

  details.innerHTML = `
    Seat <strong>${seatId}</strong> booked for <strong>${shift}</strong> shift<br>
    From <strong>${startDate}</strong> to <strong>${endDate}</strong>.
  `;

  modal.classList.remove('hidden');

  closeBtn.onclick = () => {
    modal.classList.add('hidden');
    window.location.href = 'index.html'; // ğŸ” Redirect and reload to show updated seat
  };
}
  
  </script>
  <script>
  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = document.getElementById('installBtn');
    installBtn.style.display = 'flex';

    installBtn.addEventListener('click', () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choiceResult => {
        if (choiceResult.outcome === 'accepted') {
          console.log('âœ… App installed');
        } else {
          console.log('âŒ User dismissed');
        }
        installBtn.style.display = 'none';
      });
    });
  });
</script>




  </div>
</div>

</body>
</html>
